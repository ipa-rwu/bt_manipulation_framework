<root main_tree_to_execute="MainTree">
  <BehaviorTree ID="Initialization">
    <Sequence>
      <Action ID="UpdateParameter" data_type="double" topic="/arm_parameter_server" />
      <Action ID="UpdateParameter" data_type="string" topic="/gripper_parameter_server" />
      <Action ID="UpdateParameter" data_type="bool" topic="/task_flag_parameter_server" />
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="MainTree">
    <Sequence name="Job">
      <Fallback name="Help">
        <Action ID="CheckTaskResult" task_name="Help" />
        <Action ID="CallExternHelp" service_name="help_server" />
        <SubTree ID="Initialization" __shared_blackboard="true" />
      </Fallback>
      <Fallback name="task1">
        <Inverter>
          <SetBlackboard name="setTaskName" output_key="current_task_name" value="Task1Detect" />
        </Inverter>
        <Condition ID="CheckTaskResult" task_name="{current_task_name}" />
        <SubTree ID="Task1Detect" __shared_blackboard="true" />
        <SubTree ID="NeedHelp" __shared_blackboard="true" />
      </Fallback>
      <Fallback name="task2">
        <Inverter>
          <SetBlackboard name="setTaskName" output_key="current_task_name" value="Task2Pick" />
        </Inverter>
        <Condition ID="CheckTaskResult" task_name="{current_task_name}" />
        <SubTree ID="Task2Pick" __shared_blackboard="true" />
        <SubTree ID="NeedHelp" __shared_blackboard="true" />
      </Fallback>
      <Fallback name="task3">
        <Inverter>
          <SetBlackboard name="setTaskName" output_key="current_task_name" value="Task3Place" />
        </Inverter>
        <Condition ID="CheckTaskResult" task_name="{current_task_name}" />
        <SubTree ID="Task3Place" __shared_blackboard="true" />
        <SubTree ID="NeedHelp" __shared_blackboard="true" />
      </Fallback>
      <Sequence name="AllFinish">
        <Condition ID="SetFlagTask" success="false" task_name="Task1Detect" />
        <Condition ID="SetFlagTask" success="false" task_name="Task2Pick" />
        <Condition ID="SetFlagTask" success="false" task_name="Task3Place" />
      </Sequence>
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="Task1Detect">
    <Sequence name="steps">
      <Sequence name="task1step1">
        <Action ID="FindObjects" container="{container}" container_A="-0.35;0.55;0.78;0;0.707;0;0.707;" container_B="0.35;0.55;0.78;0;0.707;0;0.707" frame_id="world" marker="{marker}" marker_id="1" />
      </Sequence>
      <Sequence name="task1finish">
        <Condition ID="SetFlagTask" success="true" task_name="{current_task_name}" />
      </Sequence>
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="Task2Pick">
    <Sequence name="steps">
      <Sequence name="task2step1">
        <Action ID="UpdateGoalForArm" based_on_pose="{marker}" goal="{arm_goal}" step="task2step1" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task2step2">
        <Action ID="UpdateGoalForArm" based_on_pose="{marker}" goal="{arm_goal}" step="task2step2" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task2step3">
        <Action ID="UpdateGoalForArm" based_on_pose="{marker}" goal="{arm_goal}" step="task2step3" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task2finish">
        <Condition ID="SetFlagTask" success="true" task_name="{current_task_name}" />
      </Sequence>
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="Task3Place">
    <Sequence name="steps">
      <Sequence name="task3step1">
        <Action ID="UpdateGoalForArm" based_on_pose="{container}" goal="{arm_goal}" step="task3step1" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task3step2">
        <Action ID="UpdateGoalForArm" based_on_pose="{container}" goal="{arm_goal}" step="task3step2" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task3step3">
        <Action ID="UpdateGoalForArm" based_on_pose="{container}" goal="{arm_goal}" step="task3step3" />
        <Action ID="ComputePathArm" goal="{arm_goal}" plan="{plan}" replan_times="1" target_type="Cartesian" />
        <SubTree ID="Execution" __shared_blackboard="true" />
      </Sequence>
      <Sequence name="task3finish">
        <Condition ID="SetFlagTask" success="true" task_name="{current_task_name}" />
      </Sequence>
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="NeedHelp">
    <Condition ID="SetFlagTask" success="false" task_name="{current_task_name}" />
  </BehaviorTree>
  <BehaviorTree ID="Execution">
    <Sequence name="arm_gripper_execute">
      <Action ID="ExecuteTrajectoryArm" plan="{plan}" />
      <Action ID="ExecuteTrajectoryGripper" step="{current_step}" />
    </Sequence>
  </BehaviorTree>
</root>
